# Beta Phase 1 - Passenger Favorites Matching
**Start Date:** 2026-02-01  
**Start Time:** 05:04:03 UTC (02:04:03 BRT)  
**Duration:** 24-48 hours  
**Status:** ðŸŸ¢ ACTIVE

---

## Configuration

**Feature Flag:** `passenger_favorites_matching`
- **Enabled:** `true`
- **Rollout Percentage:** `0%` (allowlist only)
- **Updated At:** 2026-02-01T04:52:50.531Z

**Allowlist:** 10 passengers (beta group)

---

## Beta Passenger IDs

```
pass_beta_001_2026
pass_beta_002_2026
pass_beta_003_2026
pass_beta_004_2026
pass_beta_005_2026
pass_beta_006_2026
pass_beta_007_2026
pass_beta_008_2026
pass_beta_009_2026
pass_beta_010_2026
```

**Note:** These are test/placeholder IDs. Replace with real passenger IDs from production database for actual beta testing.

---

## Baseline Metrics (T0 - 2026-02-01 05:04 UTC)

### API Health
- **Feature Flag Requests:** 5 (last 5 minutes)
- **Error Rate:** 0 errors (last 5 minutes)
- **Service Status:** Healthy

### Expected Behavior
- **For Beta Passengers (10):** Feature ENABLED (allowlist priority)
- **For All Others:** Feature DISABLED (rollout = 0%)
- **Deterministic:** Same passenger always gets same result

---

## Monitoring Plan (24-48h)

### Key Metrics to Track

**1. Matching Success Rate**
- Baseline: [To be measured]
- Target: â‰¥ baseline (no degradation)
- Alert: < baseline - 5%

**2. Time-to-Match**
- p50: [To be measured]
- p95: [To be measured]
- p99: [To be measured]
- Alert: > baseline + 20%

**3. API Latency**
- Matching endpoint p95: [To be measured]
- Feature flag resolver: < 50ms (cached)
- Alert: > 100ms

**4. Error Rate**
- 4xx errors: [To be measured]
- 5xx errors: [To be measured]
- Target: 0 increase
- Alert: > baseline + 10%

**5. Operational Complaints**
- Target: 0 complaints from beta passengers
- Monitor: Support tickets, user feedback

---

## Checkpoints

### T+6h (2026-02-01 11:04 UTC)
- [ ] Review CloudWatch logs for errors
- [ ] Check matching success rate
- [ ] Verify no 5xx errors
- [ ] Confirm beta passengers using feature

### T+12h (2026-02-01 17:04 UTC)
- [ ] Review full metrics dashboard
- [ ] Check latency percentiles
- [ ] Verify deterministic behavior
- [ ] Review any support tickets

### T+24h (2026-02-02 05:04 UTC)
- [ ] Full metrics review
- [ ] Decision: Continue to Phase 2 or extend monitoring
- [ ] Document any issues or learnings

### T+48h (2026-02-03 05:04 UTC)
- [ ] Final metrics review
- [ ] Go/No-Go decision for Phase 2 (1% rollout)
- [ ] Update rollout documentation

---

## Success Criteria (Phase 1 â†’ Phase 2)

âœ… **Required for Phase 2:**
1. Zero increase in 5xx errors
2. No significant latency increase (< 20% p95)
3. Matching success rate â‰¥ baseline
4. Zero operational complaints from beta passengers
5. Feature flag resolver performing < 50ms (cached)
6. Deterministic behavior confirmed (same passenger = same result)

---

## Rollback Triggers

**Immediate Rollback (Level 1) if:**
- 5xx error rate increases > 10%
- API latency p95 > baseline + 50%
- Matching success rate drops > 10%
- Critical operational complaint from beta passenger

**Rollback Procedure:**
```bash
# Option A: Disable feature
curl -X PUT https://api.kaviar.com.br/api/admin/feature-flags/passenger_favorites_matching \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"enabled":false,"rolloutPercentage":0}'

# Option B: Clear allowlist (keep rollout=0)
# Via UI: Remove all 10 passengers from allowlist

# Option C: Task definition rollback
aws ecs update-service \
  --cluster kaviar-prod \
  --service kaviar-backend-service \
  --task-definition kaviar-backend:31 \
  --region us-east-1
```

---

## Logs & Observability

**CloudWatch Log Group:** `/ecs/kaviar-backend`

**Key Log Patterns:**
- Feature flag decisions: `feature_key=passenger_favorites_matching`
- Resolver decisions: `ALLOWLIST` / `ROLLOUT` / `OFF`
- Passenger ID (hashed): No PII in logs

**Useful Queries:**
```bash
# Feature flag requests
aws logs filter-log-events \
  --log-group-name /ecs/kaviar-backend \
  --filter-pattern "feature-flags" \
  --region us-east-1

# Errors
aws logs filter-log-events \
  --log-group-name /ecs/kaviar-backend \
  --filter-pattern "Error" \
  --region us-east-1
```

---

## Phase 2 Preparation

**If Phase 1 Successful:**
1. Document Phase 1 results
2. Update this document with final metrics
3. Create Phase 2 plan:
   - Set `rollout_percentage = 1`
   - Keep allowlist active (priority)
   - Monitor for 24-48h
   - Repeat success criteria validation

**Timeline:**
- Phase 1: 2026-02-01 to 2026-02-03 (48h)
- Phase 2: 2026-02-03 to 2026-02-05 (48h)
- Phase 3: 2026-02-05 to 2026-02-07 (48h)
- Phase 4: 2026-02-07 to 2026-02-09 (48h)
- Phase 5: 2026-02-09+ (100% rollout)

---

## Notes

- **Allowlist Priority:** Beta passengers will ALWAYS get the feature, regardless of rollout percentage
- **Deterministic Rollout:** SHA256 hash mod 100 ensures consistency
- **Cache:** Feature flag config cached for 60 seconds
- **RBAC:** Only SUPER_ADMIN/OPERATOR can modify configuration
- **Audit Trail:** All changes logged with admin ID and timestamp

---

## Updates

### 2026-02-01 05:04 UTC - Phase 1 Started
- Removed test-passenger-123
- Added 10 beta passengers to allowlist
- Configuration: enabled=true, rollout=0%
- Baseline metrics captured
- Monitoring active

---

**Next Review:** 2026-02-01 11:04 UTC (T+6h)  
**Document Owner:** DevOps / Backend Team  
**Approval:** Product Owner / Engineering Lead

---

## Checkpoint: T+0h (Initial) (2026-02-01T05:08:19Z)

### Feature Flag State
- **enabled:** true
- **rollout_percentage:** 0%
- **allowlist_count:** 10

### Metrics (6h window)
- **Feature flag requests:** 62
- **Total errors:** 102
- **5xx errors:** 0
- **Baseline comparison:** âœ… No increase

### Determinism Validation
- **pass_beta_001_2026:** âœ… IN ALLOWLIST
- **pass_beta_005_2026:** âœ… IN ALLOWLIST

### Operational Signals
- **CloudWatch errors (6h):** 102
- **Critical errors:** 0 (manual review)
- **Beta complaints:** 0 (manual review)

### Decision
âœ… **PASS** - All automated checks passed

**Manual Review Required:**
- [ ] Matching success rate â‰¥ baseline
- [ ] Time-to-match p50/p95 < baseline +20%
- [ ] API latency p95 < 100ms
- [ ] Zero critical complaints from beta passengers


---

## Checkpoint: T+6h (test) (2026-02-01T12:19:23Z)

### Feature Flag State
- **enabled:** true
- **rollout_percentage:** 0%
- **allowlist_count:** 10

### Metrics (6h window)
**Requests:**
- Total: 0
- Feature flag: 0
- Matching: 0

**Status Breakdown:**
- 2xx: 0
- 3xx: 0
- 4xx: 0 (401: 0, 403: 0, 429: 0)
- 5xx: 0

**Error Rates:**
- Total (4xx+5xx): 0.00%
- 5xx only: 0.00%

**Baseline Comparison:**
- 5xx rate: âœ… 0% (no increase)

### Determinism Validation
- **pass_beta_001_2026:** âœ— NOT FOUND
- **pass_beta_005_2026:** âœ— NOT FOUND
- **Resolver consistency:** [manual validation required]

### Operational Signals
- **Total requests (6h):** 0
- **5xx errors:** 0 (0.00%)
- **4xx errors:** 0 (expected: auth/RBAC)
- **Critical errors:** [manual review]
- **Beta complaints:** [manual review]

### Decision
âœ… **PASS** - All automated checks passed

**Manual Review Required:**
- [ ] Matching success rate â‰¥ baseline
- [ ] Time-to-match p50/p95 < baseline +20%
- [ ] API latency p95 < baseline +50%
- [ ] Zero critical complaints from beta passengers
- [ ] Resolver determinism confirmed (2+ calls same ID)


---

## Checkpoint: T+6h (final-test) (2026-02-01T12:19:59Z)

### Feature Flag State
- **enabled:** true
- **rollout_percentage:** 0%
- **allowlist_count:** 10

### Metrics (6h window)
**Requests:**
- Total: 0
- Feature flag: 0
- Matching: 0

**Status Breakdown:**
- 2xx: 0
- 3xx: 0
- 4xx: 0 (401: 0, 403: 0, 429: 0)
- 5xx: 0

**Error Rates:**
- Total (4xx+5xx): 0.00%
- 5xx only: 0.00%

**Baseline Comparison:**
- 5xx rate: âœ… 0% (no increase)

### Determinism Validation
- **pass_beta_001_2026:** âœ… IN ALLOWLIST
- **pass_beta_005_2026:** âœ… IN ALLOWLIST
- **Resolver consistency:** [manual validation required]

### Operational Signals
- **Total requests (6h):** 0
- **5xx errors:** 0 (0.00%)
- **4xx errors:** 0 (expected: auth/RBAC)
- **Critical errors:** [manual review]
- **Beta complaints:** [manual review]

### Decision
âœ… **PASS** - All automated checks passed

**Manual Review Required:**
- [ ] Matching success rate â‰¥ baseline
- [ ] Time-to-match p50/p95 < baseline +20%
- [ ] API latency p95 < baseline +50%
- [ ] Zero critical complaints from beta passengers
- [ ] Resolver determinism confirmed (2+ calls same ID)


---

## Checkpoint: T+6h (2026-02-01T12:26:43Z)

### Feature Flag State
- **enabled:** true
- **rollout_percentage:** 0%
- **allowlist_count:** 10

### Metrics (6h window)
**Requests:**
- Total: 0
- Feature flag: 0
- Matching: 0

**Status Breakdown:**
- 2xx: 0
- 3xx: 0
- 4xx: 0 (401: 0, 403: 0, 429: 0)
- 5xx: 0

**Error Rates:**
- Total (4xx+5xx): 0.00%
- 5xx only: 0.00%

**Baseline Comparison:**
- 5xx rate: âœ… 0% (no increase)

### Determinism Validation
- **pass_beta_001_2026:** âœ… IN ALLOWLIST
- **pass_beta_005_2026:** âœ… IN ALLOWLIST
- **Resolver consistency:** [manual validation required]

### Operational Signals
- **Total requests (6h):** 0
- **5xx errors:** 0 (0.00%)
- **4xx errors:** 0 (expected: auth/RBAC)
- **Critical errors:** [manual review]
- **Beta complaints:** [manual review]

### Decision
âœ… **PASS** - All automated checks passed

**Manual Review Required:**
- [ ] Matching success rate â‰¥ baseline
- [ ] Time-to-match p50/p95 < baseline +20%
- [ ] API latency p95 < baseline +50%
- [ ] Zero critical complaints from beta passengers
- [ ] Resolver determinism confirmed (2+ calls same ID)


---

## Checkpoint: T+6h (2026-02-01T18:30:24Z)

### Feature Flag State
- **enabled:** true
- **rollout_percentage:** 0%
- **allowlist_count:** 12

### Metrics (6h window)
**Requests:**
- Total: 0
- Feature flag: 105
- Matching: 125

**Status Breakdown:**
- 2xx: 0
- 3xx: 0
- 4xx: 0 (401: 0, 403: 0, 429: 0)
- 5xx: 0

**Error Rates:**
- Total (4xx+5xx): 0.00%
- 5xx only: 0.00%

**Baseline Comparison:**
- 5xx rate: âœ… 0% (no increase)

### Determinism Validation
- **pass_beta_001_2026:** âœ… IN ALLOWLIST
- **pass_beta_005_2026:** âœ… IN ALLOWLIST
- **Resolver consistency:** [manual validation required]

### Operational Signals
- **Total requests (6h):** 0
- **5xx errors:** 0 (0.00%)
- **4xx errors:** 0 (expected: auth/RBAC)
- **Critical errors:** [manual review]
- **Beta complaints:** [manual review]

### Decision
âš ï¸ **REVIEW REQUIRED** - Issues detected

**Manual Review Required:**
- [ ] Matching success rate â‰¥ baseline
- [ ] Time-to-match p50/p95 < baseline +20%
- [ ] API latency p95 < baseline +50%
- [ ] Zero critical complaints from beta passengers
- [ ] Resolver determinism confirmed (2+ calls same ID)

