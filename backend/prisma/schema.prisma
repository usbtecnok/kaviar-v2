generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admins {
  id            String   @id
  name          String
  email         String   @unique
  password_hash String
  is_active     Boolean  @default(true)
  role_id       String
  created_at    DateTime @default(now())
  updated_at    DateTime
  roles         roles    @relation(fields: [role_id], references: [id])
}

model communities {
  id                  String   @id
  name                String
  neighborhood_id     String
  is_active           Boolean  @default(true)
  operational_profile String   @default("NORMAL") // NORMAL | RESTRICTED | PRIORITY | PRIVATE
  notes               String?
  created_at          DateTime @default(now())
  updated_at          DateTime
  neighborhoods       neighborhoods @relation(fields: [neighborhood_id], references: [id])
  rides               rides[]
}

model consents {
  id           String    @id
  user_id      String
  subject_type String?
  subject_id   String?
  type         String
  consent_type String?
  accepted     Boolean   @default(false)
  accepted_at  DateTime?
  ip_address   String?
  user_agent   String?
  created_at   DateTime  @default(now())

  @@unique([subject_type, subject_id, type], map: "consent_subject_type_subject_id_type_key")
  @@unique([user_id, type], map: "consent_user_id_type_key")
}

model diamond_audit_logs {
  id                 String   @id
  ride_id            String
  driver_id          String?
  action             String
  reason             String?
  bonus_amount       Decimal? @db.Decimal(10, 2)
  diamond_state_from String?
  diamond_state_to   String?
  details            Json?
  created_at         DateTime @default(now())
}

model driver_documents {
  id                   String    @id
  driver_id            String
  type                 String
  document_url         String    @default("")
  file_url             String?
  status               String    @default("pending")
  submitted_at         DateTime?
  verified_at          DateTime?
  verified_by_admin_id String?
  rejected_at          DateTime?
  rejected_by_admin_id String?
  reject_reason        String?
  created_at           DateTime  @default(now())
  updated_at           DateTime
}

model driver_enforcement_history {
  id         String   @id
  driver_id  String
  action     String
  reason     String?
  metadata   Json?
  admin_id   String
  created_at DateTime @default(now())
}

model driver_verifications {
  id                     String    @id
  driver_id              String    @unique
  status                 String    @default("pending")
  verified_at            DateTime?
  approved_at            DateTime?
  approved_by_admin_id   String?
  eligibility_checked_at DateTime?
  created_at             DateTime  @default(now())
  updated_at             DateTime
}

model drivers {
  id                       String       @id
  name                     String
  email                    String       @unique
  password_hash            String?
  phone                    String?
  status                   String       @default("pending")
  suspension_reason        String?
  suspended_at             DateTime?
  suspended_by             String?
  last_active_at           DateTime?
  document_cpf             String?
  document_rg              String?
  document_cnh             String?
  vehicle_plate            String?
  vehicle_model            String?
  banned_at                DateTime?
  banned_reason            String?
  banned_by                String?
  deleted_at               DateTime?
  deleted_by               String?
  last_location_updated_at DateTime?
  last_lat                 Decimal?     @db.Decimal(10, 8)
  last_lng                 Decimal?     @db.Decimal(11, 8)
  is_premium               Boolean      @default(false)
  premium_override         Boolean?
  created_at               DateTime     @default(now())
  updated_at               DateTime
  rides                    rides[]
}

model elderly_contracts {
  id                 String           @id
  elderly_profile_id String
  responsible_id     String?
  status             String           @default("ACTIVE")
  service_type       String           @default("ACOMPANHAMENTO_ATIVO")
  starts_at          DateTime
  ends_at            DateTime?
  notes              String?
  created_at         DateTime         @default(now())
  updated_at         DateTime
  elderly_profiles   elderly_profiles @relation(fields: [elderly_profile_id], references: [id], onDelete: Cascade)
  passengers         passengers?      @relation(fields: [responsible_id], references: [id])
}

model elderly_profiles {
  id                String              @id
  passenger_id      String              @unique
  emergency_contact String?
  emergency_phone   String?
  medical_notes     String?
  careLevel         String              @default("basic")
  created_at        DateTime            @default(now())
  updated_at        DateTime
  elderly_contracts elderly_contracts[]
  passengers        passengers          @relation(fields: [passenger_id], references: [id], onDelete: Cascade)
}

model neighborhood_geofences {
  id              String        @id
  neighborhood_id String        @unique
  geofence_type   String
  coordinates     Json
  source          String?
  source_url      String?
  area            Decimal?      @db.Decimal(15, 6)
  perimeter       Decimal?      @db.Decimal(15, 6)
  created_at      DateTime      @default(now())
  updated_at      DateTime
  neighborhoods   neighborhoods @relation(fields: [neighborhood_id], references: [id], onDelete: Cascade)
}

model neighborhoods {
  id                     String                  @id
  name                   String                  @unique
  description            String?
  zone                   String?
  administrative_region  String?
  is_active              Boolean                 @default(true)
  center_lat             Decimal?                @db.Decimal(10, 8)
  center_lng             Decimal?                @db.Decimal(11, 8)
  is_verified            Boolean                 @default(false)
  verified_at            DateTime?
  verified_by            String?
  created_at             DateTime                @default(now())
  updated_at             DateTime
  neighborhood_geofences neighborhood_geofences?
  communities            communities[]
  rides                  rides[]
  pricing_tables         pricing_tables[]
}

model passengers {
  id                       String               @id
  name                     String
  email                    String               @unique
  password_hash            String?
  phone                    String?
  status                   String               @default("pending")
  last_lat                 Decimal?             @db.Decimal(10, 8)
  last_lng                 Decimal?             @db.Decimal(11, 8)
  last_location_updated_at DateTime?
  created_at               DateTime             @default(now())
  updated_at               DateTime
  elderly_contracts        elderly_contracts[]
  elderly_profiles         elderly_profiles?
  ride_confirmations       ride_confirmations[]
  rides                    rides[]
  tour_bookings            tour_bookings[]
  user_consents            user_consents[]
}

model rating_stats {
  id             String   @id
  entity_type    String
  entity_id      String
  user_id        String?  @unique
  average_rating Decimal  @db.Decimal(3, 2)
  total_ratings  Int
  rating_sum     Int
  updated_at     DateTime
  last_updated   DateTime

  @@unique([entity_type, entity_id])
}

model ratings {
  id          String   @id
  entity_type String
  entity_id   String
  user_id     String
  ride_id     String?
  rated_id    String?
  rater_id    String?
  rater_type  String?
  rating      Int
  score       Int      @default(0)
  comment     String?
  created_at  DateTime @default(now())

  @@unique([ride_id, user_id], map: "rating_ride_id_user_id_key")
}

model ride_admin_actions {
  id         String   @id
  ride_id    String
  admin_id   String
  action     String
  reason     String?
  old_value  String?
  new_value  String?
  created_at DateTime @default(now())
  rides      rides    @relation(fields: [ride_id], references: [id])
}

model ride_confirmations {
  id                 String     @id
  passenger_id       String
  confirmation_token String     @unique
  ride_data          Json
  expires_at         DateTime
  is_used            Boolean    @default(false)
  used_at            DateTime?
  created_ride_id    String?
  created_at         DateTime   @default(now())
  passengers         passengers @relation(fields: [passenger_id], references: [id])
}

model ride_status_history {
  id         String   @id
  ride_id    String
  status     String
  created_at DateTime @default(now())
  rides      rides    @relation(fields: [ride_id], references: [id])
}

model rides {
  id                          String                @id
  driver_id                   String?
  passenger_id                String
  neighborhood_id             String                // OBRIGATÓRIO - âncora territorial
  community_id                String?               // OPCIONAL - modificador operacional
  origin                      String
  destination                 String
  type                        String                @default("normal")
  status                      String                @default("requested")
  price                       Decimal               @db.Decimal(10, 2)
  platform_fee                Decimal?              @db.Decimal(10, 2)
  driver_amount               Decimal?              @db.Decimal(10, 2)
  payment_method              String?               @default("credit_card")
  cancel_reason               String?
  cancelled_by                String?
  cancelled_at                DateTime?
  forced_completed_by         String?
  forced_completed_at         DateTime?
  fallback_out_of_fence       Boolean?              @default(false)
  fallback_reason             String?
  drivers_in_fence_count      Int?
  passenger_confirmed_at      DateTime?
  is_diamond_eligible         Boolean?              @default(false)
  diamond_state               String?
  diamond_candidate_driver_id String?
  diamond_lost_at             DateTime?
  diamond_lost_reason         String?
  bonus_amount                Decimal?              @db.Decimal(10, 2)
  bonus_applied_at            DateTime?
  created_at                  DateTime              @default(now())
  updated_at                  DateTime
  ride_admin_actions          ride_admin_actions[]
  ride_status_history         ride_status_history[]
  ride_pricing                ride_pricing?
  drivers                     drivers?              @relation(fields: [driver_id], references: [id])
  passengers                  passengers            @relation(fields: [passenger_id], references: [id])
  neighborhoods               neighborhoods         @relation(fields: [neighborhood_id], references: [id])
  communities                 communities?          @relation(fields: [community_id], references: [id])
}

model pricing_tables {
  id              String   @id
  neighborhood_id String
  base_fare       Decimal  @db.Decimal(10, 2)
  per_km          Decimal  @db.Decimal(10, 2)
  per_min         Decimal  @db.Decimal(10, 2)
  minimum_fare    Decimal  @db.Decimal(10, 2)
  is_active       Boolean  @default(true)
  version         String
  created_at      DateTime @default(now())
  updated_at      DateTime
  neighborhoods   neighborhoods @relation(fields: [neighborhood_id], references: [id])
}

model ride_pricing {
  id              String   @id
  ride_id         String   @unique
  pricing_version String
  neighborhood_id String
  community_id    String?
  base_fare       Decimal  @db.Decimal(10, 2)
  distance_km     Decimal  @db.Decimal(8, 3)
  duration_min    Int
  modifiers       String?  // JSON
  final_fare      Decimal  @db.Decimal(10, 2)
  driver_payout   Decimal  @db.Decimal(10, 2)
  platform_fee    Decimal  @db.Decimal(10, 2)
  created_at      DateTime @default(now())
  rides           rides    @relation(fields: [ride_id], references: [id])
}

model roles {
  id         String   @id
  name       String   @unique
  created_at DateTime @default(now())
  updated_at DateTime
  admins     admins[]
}

model tour_bookings {
  id                String            @id
  package_id        String
  passenger_id      String?
  status            TourBookingStatus @default(REQUESTED)
  scheduled_date    DateTime?
  scheduled_at      DateTime?
  pickup_location   String?
  dropoff_location  String?
  passenger_name    String?
  passenger_email   String?
  passenger_phone   String?
  passenger_count   Int               @default(1)
  special_requests  String?
  emergency_contact String?
  emergency_phone   String?
  total_price       Decimal           @default(0) @db.Decimal(10, 2)
  ride_id           String?
  confirmed_by      String?
  confirmed_at      DateTime?
  created_at        DateTime          @default(now())
  updated_at        DateTime
  tour_packages     tour_packages     @relation(fields: [package_id], references: [id])
  passengers        passengers?       @relation(fields: [passenger_id], references: [id])
}

model tour_packages {
  id                         String          @id
  title                      String
  description                String
  type                       TourPackageType
  partner_name               String
  base_price                 Decimal         @db.Decimal(10, 2)
  locations                  String[]
  estimated_duration_minutes Int
  is_active                  Boolean         @default(true)
  created_by                 String?
  created_at                 DateTime        @default(now())
  updated_at                 DateTime
  tour_bookings              tour_bookings[]
}

model tourist_guides {
  id           String      @id
  name         String
  email        String      @unique
  phone        String?
  status       String      @default("pending")
  is_bilingual Boolean     @default(false)
  languages    String[]
  also_driver  Boolean     @default(false)
  driver_id    String?
  created_at   DateTime    @default(now())
  updated_at   DateTime
}

model user_consents {
  id           String     @id
  passenger_id String
  consent_type String
  accepted     Boolean    @default(false)
  accepted_at  DateTime?
  ip_address   String?
  created_at   DateTime   @default(now())
  passengers   passengers @relation(fields: [passenger_id], references: [id])

  @@unique([passenger_id, consent_type])
}

enum TourBookingStatus {
  REQUESTED
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum TourPackageType {
  TOUR
  AIRPORT_TRANSFER
}
