generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model admins {
  id                   String              @id @default(uuid())
  name                 String
  email                String              @unique
  password             String
  role                 String              @default("SUPER_ADMIN")
  is_active            Boolean             @default(true)
  must_change_password Boolean             @default(true)
  password_changed_at  DateTime?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt
  community_leaders    community_leaders[]
}

model communities {
  id                       String                     @id
  name                     String
  description              String?
  is_active                Boolean                    @default(true)
  center_lat               Decimal?                   @db.Decimal(10, 8)
  center_lng               Decimal?                   @db.Decimal(11, 8)
  radius_meters            Int?
  geofence                 String?
  min_active_drivers       Int                        @default(3)
  deactivation_threshold   Int                        @default(1)
  auto_activation          Boolean                    @default(false)
  last_evaluated_at        DateTime?
  created_at               DateTime                   @default(now())
  updated_at               DateTime
  community_geofences      community_geofences?
  community_leaders        community_leaders[]
  community_status_history community_status_history[]
  drivers                  drivers[]
  elderly_contracts        elderly_contracts[]
  passengers               passengers[]
  tourist_guides           tourist_guides[]
}

model community_geofences {
  id           String      @id
  community_id String      @unique
  center_lat   Decimal     @db.Decimal(10, 8)
  center_lng   Decimal     @db.Decimal(11, 8)
  min_lat      Decimal?    @db.Decimal(10, 8)
  min_lng      Decimal?    @db.Decimal(11, 8)
  max_lat      Decimal?    @db.Decimal(10, 8)
  max_lng      Decimal?    @db.Decimal(11, 8)
  geojson      String?
  source       String
  source_ref   String?
  confidence   String
  is_verified  Boolean     @default(false)
  review_notes String?
  created_at   DateTime    @default(now())
  updated_at   DateTime
  communities  communities @relation(fields: [community_id], references: [id], onDelete: Cascade)
}

model community_status_history {
  id             String      @id
  community_id   String
  status         String
  from_is_active Boolean?
  to_is_active   Boolean?
  driver_count   Int?
  changed_by     String?
  reason         String?
  created_at     DateTime    @default(now())
  communities    communities @relation(fields: [community_id], references: [id])
}

model consents {
  id           String    @id
  user_id      String
  subject_type String?
  subject_id   String?
  type         String
  consent_type String?
  accepted     Boolean   @default(false)
  accepted_at  DateTime?
  ip_address   String?
  user_agent   String?
  created_at   DateTime  @default(now())

  @@unique([subject_type, subject_id, type], map: "consent_subject_type_subject_id_type_key")
  @@unique([user_id, type], map: "consent_user_id_type_key")
}

model diamond_audit_logs {
  id                 String   @id
  ride_id            String
  driver_id          String?
  action             String
  reason             String?
  bonus_amount       Decimal? @db.Decimal(10, 2)
  diamond_state_from String?
  diamond_state_to   String?
  details            Json?
  created_at         DateTime @default(now())
}

model driver_documents {
  id                   String    @id
  driver_id            String
  type                 String
  document_url         String    @default("")
  file_url             String?
  status               String    @default("pending")
  submitted_at         DateTime?
  verified_at          DateTime?
  verified_by_admin_id String?
  rejected_at          DateTime?
  rejected_by_admin_id String?
  reject_reason        String?
  created_at           DateTime  @default(now())
  updated_at           DateTime

  @@unique([driver_id, type], name: "driver_id_type", map: "driver_documents_driver_type_uniq")
}

model driver_enforcement_history {
  id         String   @id
  driver_id  String
  action     String
  reason     String?
  metadata   Json?
  admin_id   String
  created_at DateTime @default(now())
}

model driver_verifications {
  id                     String    @id
  driver_id              String    @unique
  community_id           String?
  status                 String    @default("pending")
  verified_at            DateTime?
  approved_at            DateTime?
  approved_by_admin_id   String?
  eligibility_checked_at DateTime?
  created_at             DateTime  @default(now())
  updated_at             DateTime
}

model drivers {
  id                          String                        @id
  name                        String
  email                       String                        @unique
  password_hash               String?
  phone                       String?
  status                      String                        @default("pending")
  suspension_reason           String?
  suspended_at                DateTime?
  suspended_by                String?
  last_active_at              DateTime?
  neighborhood_id             String?
  community_id                String?
  document_cpf                String?
  document_rg                 String?
  document_cnh                String?
  vehicle_plate               String?
  vehicle_model               String?
  vehicle_color               String?
  banned_at                   DateTime?
  banned_reason               String?
  banned_by                   String?
  deleted_at                  DateTime?
  deleted_by                  String?
  last_location_updated_at    DateTime?
  last_lat                    Decimal?                      @db.Decimal(10, 8)
  last_lng                    Decimal?                      @db.Decimal(11, 8)
  virtual_fence_center_lat    Decimal?                      @db.Decimal(10, 8)
  virtual_fence_center_lng    Decimal?                      @db.Decimal(11, 8)
  secondary_base_lat          Decimal?                      @db.Decimal(10, 8)
  secondary_base_lng          Decimal?                      @db.Decimal(11, 8)
  secondary_base_label        String?
  secondary_base_enabled      Boolean                       @default(false)
  is_premium                  Boolean                       @default(false)
  premium_override            Boolean?
  certidao_nada_consta_url    String?
  pix_key                     String?
  pix_key_type                String?
  family_bonus_accepted       Boolean?                      @default(false)
  family_bonus_profile        String?
  approved_at                 DateTime?
  approved_by                 String?
  rejected_at                 DateTime?
  rejected_by                 String?
  rejected_reason             String?
  created_at                  DateTime                      @default(now())
  updated_at                  DateTime
  driver_compliance_documents driver_compliance_documents[]
  driver_consents             driver_consents?
  communities                 communities?                  @relation(fields: [community_id], references: [id])
  neighborhoods               neighborhoods?                @relation(fields: [neighborhood_id], references: [id])
  match_logs                  match_logs[]
  rides                       rides[]
}

model elderly_contracts {
  id                 String           @id
  elderly_profile_id String
  responsible_id     String?
  community_id       String
  status             String           @default("ACTIVE")
  service_type       String           @default("ACOMPANHAMENTO_ATIVO")
  starts_at          DateTime
  ends_at            DateTime?
  notes              String?
  created_at         DateTime         @default(now())
  updated_at         DateTime
  communities        communities      @relation(fields: [community_id], references: [id])
  elderly_profiles   elderly_profiles @relation(fields: [elderly_profile_id], references: [id], onDelete: Cascade)
  passengers         passengers?      @relation(fields: [responsible_id], references: [id])
}

model elderly_profiles {
  id                String              @id
  passenger_id      String              @unique
  emergency_contact String?
  emergency_phone   String?
  medical_notes     String?
  careLevel         String              @default("basic")
  created_at        DateTime            @default(now())
  updated_at        DateTime
  elderly_contracts elderly_contracts[]
  passengers        passengers          @relation(fields: [passenger_id], references: [id], onDelete: Cascade)
}

model neighborhood_geofences {
  id              String                   @id
  neighborhood_id String                   @unique
  geofence_type   String
  coordinates     Json
  source          String?
  source_url      String?
  area            Decimal?                 @db.Decimal(15, 6)
  perimeter       Decimal?                 @db.Decimal(15, 6)
  created_at      DateTime                 @default(now())
  updated_at      DateTime
  geom            Unsupported("geometry")?
  neighborhoods   neighborhoods            @relation(fields: [neighborhood_id], references: [id], onDelete: Cascade)

  @@index([geom], map: "idx_neighborhood_geofences_geom", type: Gist)
}

model neighborhoods {
  id                     String                  @id
  name                   String
  city                   String                  @default("Rio de Janeiro")
  description            String?
  zone                   String?
  administrative_region  String?
  is_active              Boolean                 @default(true)
  center_lat             Decimal?                @db.Decimal(10, 8)
  center_lng             Decimal?                @db.Decimal(11, 8)
  is_verified            Boolean                 @default(false)
  verified_at            DateTime?
  verified_by            String?
  created_at             DateTime                @default(now())
  updated_at             DateTime
  area_type              String?                 @default("BAIRRO_OFICIAL") @db.VarChar(50)
  parent_neighborhood_id String?
  population             Int?
  area_km2               Decimal?                @db.Decimal(10, 2)
  community_leaders      community_leaders[]
  drivers                drivers[]
  match_logs             match_logs[]
  neighborhood_geofences neighborhood_geofences?
  passengers             passengers[]

  @@unique([name, city])
  @@index([city])
  @@index([area_type], map: "idx_neighborhoods_area_type")
  @@index([city, area_type], map: "idx_neighborhoods_city_type")
  @@index([parent_neighborhood_id], map: "idx_neighborhoods_parent")
}

model community_leaders {
  id                  String         @id @default(uuid())
  name                String
  email               String         @unique
  phone               String?
  neighborhood_id     String?
  community_id        String?
  leader_type         String
  verification_status String         @default("PENDING")
  verification_notes  String?
  verified_by         String?
  verified_at         DateTime?
  is_active           Boolean        @default(true)
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  community           communities?   @relation(fields: [community_id], references: [id])
  neighborhood        neighborhoods? @relation(fields: [neighborhood_id], references: [id])
  admin               admins?        @relation(fields: [verified_by], references: [id])

  @@index([neighborhood_id])
  @@index([community_id])
  @@index([verification_status])
}

model passengers {
  id                          String                        @id
  name                        String
  email                       String                        @unique
  password_hash               String?
  phone                       String?
  neighborhood_id             String?
  community_id                String?
  status                      String                        @default("pending")
  last_lat                    Decimal?                      @db.Decimal(10, 8)
  last_lng                    Decimal?                      @db.Decimal(11, 8)
  last_location_updated_at    DateTime?
  created_at                  DateTime                      @default(now())
  updated_at                  DateTime
  elderly_contracts           elderly_contracts[]
  elderly_profiles            elderly_profiles?
  match_logs                  match_logs[]
  communities                 communities?                  @relation(fields: [community_id], references: [id])
  neighborhoods               neighborhoods?                @relation(fields: [neighborhood_id], references: [id])
  passenger_favorite_locations passenger_favorite_locations[]
  ride_confirmations          ride_confirmations[]
  rides                       rides[]
  tour_bookings               tour_bookings[]
  user_consents               user_consents[]
}

model passenger_favorite_locations {
  id           String     @id @default(uuid())
  passenger_id String
  label        String
  type         String     // HOME, WORK, OTHER
  lat          Decimal    @db.Decimal(10, 8)
  lng          Decimal    @db.Decimal(11, 8)
  created_at   DateTime   @default(now())
  updated_at   DateTime   @updatedAt
  passengers   passengers @relation(fields: [passenger_id], references: [id], onDelete: Cascade)

  @@index([passenger_id])
}

model feature_flags {
  key                 String   @id @db.VarChar(100)
  enabled             Boolean  @default(false)
  rollout_percentage  Int      @default(0)
  updated_by_admin_id String?
  updated_at          DateTime @default(now())
  created_at          DateTime @default(now())
}

model feature_flag_allowlist {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key                 String   @db.VarChar(100)
  passenger_id        String
  created_by_admin_id String?
  created_at          DateTime @default(now())

  @@unique([key, passenger_id])
  @@index([key, passenger_id], map: "idx_feature_flag_allowlist_key_passenger")
}

model beta_monitor_checkpoints {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  feature_key       String
  phase             String
  checkpoint_label  String
  created_at        DateTime @default(now())
  status            String
  metrics_json      Json?    @db.JsonB
  config_json       Json?    @db.JsonB
  determinism_json  Json?    @db.JsonB
  alerts_json       Json?    @db.JsonB
  notes             String?

  @@index([feature_key, created_at(sort: Desc)], name: "idx_beta_monitor_feature_created")
  @@index([phase, created_at(sort: Desc)], name: "idx_beta_monitor_phase_created")
}

model rating_stats {
  id             String   @id
  entity_type    String
  entity_id      String
  user_id        String?  @unique
  average_rating Decimal  @db.Decimal(3, 2)
  total_ratings  Int
  rating_sum     Int
  updated_at     DateTime
  last_updated   DateTime

  @@unique([entity_type, entity_id])
}

model ratings {
  id          String   @id
  entity_type String
  entity_id   String
  user_id     String
  ride_id     String?
  rated_id    String?
  rater_id    String?
  rater_type  String?
  rating      Int
  score       Int      @default(0)
  comment     String?
  created_at  DateTime @default(now())

  @@unique([ride_id, user_id], map: "rating_ride_id_user_id_key")
}

model ride_admin_actions {
  id         String   @id
  ride_id    String
  admin_id   String
  action     String
  reason     String?
  old_value  String?
  new_value  String?
  created_at DateTime @default(now())
  rides      rides    @relation(fields: [ride_id], references: [id])
}

model ride_confirmations {
  id                 String     @id
  passenger_id       String
  confirmation_token String     @unique
  ride_data          Json
  expires_at         DateTime
  is_used            Boolean    @default(false)
  used_at            DateTime?
  created_ride_id    String?
  created_at         DateTime   @default(now())
  passengers         passengers @relation(fields: [passenger_id], references: [id])
}

model ride_status_history {
  id         String   @id
  ride_id    String
  status     String
  created_at DateTime @default(now())
  rides      rides    @relation(fields: [ride_id], references: [id])
}

model rides {
  id                          String                @id
  driver_id                   String?
  passenger_id                String
  origin                      String
  destination                 String
  type                        String                @default("normal")
  status                      String                @default("requested")
  price                       Decimal               @db.Decimal(10, 2)
  platform_fee                Decimal?              @db.Decimal(10, 2)
  driver_amount               Decimal?              @db.Decimal(10, 2)
  payment_method              String?               @default("credit_card")
  cancel_reason               String?
  cancelled_by                String?
  cancelled_at                DateTime?
  forced_completed_by         String?
  forced_completed_at         DateTime?
  fallback_out_of_fence       Boolean?              @default(false)
  fallback_reason             String?
  drivers_in_fence_count      Int?
  passenger_confirmed_at      DateTime?
  is_diamond_eligible         Boolean?              @default(false)
  diamond_state               String?
  diamond_candidate_driver_id String?
  diamond_lost_at             DateTime?
  diamond_lost_reason         String?
  bonus_amount                Decimal?              @db.Decimal(10, 2)
  bonus_applied_at            DateTime?
  created_at                  DateTime              @default(now())
  updated_at                  DateTime
  ride_admin_actions          ride_admin_actions[]
  ride_status_history         ride_status_history[]
  drivers                     drivers?              @relation(fields: [driver_id], references: [id])
  passengers                  passengers            @relation(fields: [passenger_id], references: [id])
}

model roles {
  id         String   @id
  name       String   @unique
  created_at DateTime @default(now())
  updated_at DateTime
}

model tour_bookings {
  id                String            @id
  package_id        String
  passenger_id      String?
  status            TourBookingStatus @default(REQUESTED)
  scheduled_date    DateTime?
  scheduled_at      DateTime?
  pickup_location   String?
  dropoff_location  String?
  passenger_name    String?
  passenger_email   String?
  passenger_phone   String?
  passenger_count   Int               @default(1)
  special_requests  String?
  emergency_contact String?
  emergency_phone   String?
  total_price       Decimal           @default(0) @db.Decimal(10, 2)
  ride_id           String?
  confirmed_by      String?
  confirmed_at      DateTime?
  created_at        DateTime          @default(now())
  updated_at        DateTime
  tour_packages     tour_packages     @relation(fields: [package_id], references: [id])
  passengers        passengers?       @relation(fields: [passenger_id], references: [id])
}

model tour_packages {
  id                         String          @id
  title                      String
  description                String
  type                       TourPackageType
  partner_name               String
  base_price                 Decimal         @db.Decimal(10, 2)
  locations                  String[]
  estimated_duration_minutes Int
  is_active                  Boolean         @default(true)
  created_by                 String?
  created_at                 DateTime        @default(now())
  updated_at                 DateTime
  tour_bookings              tour_bookings[]
}

model tour_partners {
  id           String   @id
  name         String
  contact_name String?
  phone        String?
  email        String?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime
}

model tour_settings {
  id                 String   @id
  support_whatsapp   String?
  default_partner_id String?
  terms_url          String?
  is_active          Boolean  @default(true)
  created_at         DateTime @default(now())
  updated_at         DateTime
}

model tourist_guides {
  id           String      @id
  name         String
  email        String      @unique
  phone        String?
  community_id String
  status       String      @default("pending")
  is_bilingual Boolean     @default(false)
  languages    String[]
  also_driver  Boolean     @default(false)
  driver_id    String?
  created_at   DateTime    @default(now())
  updated_at   DateTime
  communities  communities @relation(fields: [community_id], references: [id])
}

model user_consents {
  id           String     @id
  passenger_id String
  consent_type String
  accepted     Boolean    @default(false)
  accepted_at  DateTime?
  ip_address   String?
  created_at   DateTime   @default(now())
  passengers   passengers @relation(fields: [passenger_id], references: [id])

  @@unique([passenger_id, consent_type])
}

model driver_consents {
  id                  String   @id @default(uuid())
  driver_id           String   @unique
  terms_accepted_at   DateTime
  privacy_accepted_at DateTime
  terms_version       String
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  drivers             drivers  @relation(fields: [driver_id], references: [id], onDelete: Cascade)
}

model driver_compliance_documents {
  id                    String    @id @default(uuid())
  driver_id             String
  type                  String    @default("criminal_record")
  file_url              String
  status                String    @default("pending")
  valid_from            DateTime?
  valid_until           DateTime?
  approved_by           String?
  approved_at           DateTime?
  rejected_by           String?
  rejected_at           DateTime?
  rejection_reason      String?
  is_current            Boolean   @default(false)
  lgpd_consent_accepted Boolean   @default(false)
  lgpd_consent_ip       String?
  lgpd_consent_at       DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  drivers               drivers   @relation(fields: [driver_id], references: [id], onDelete: Cascade)

  @@index([driver_id])
  @@index([status])
  @@index([is_current])
  @@index([valid_until])
  @@map("driver_compliance_documents")
}

model match_logs {
  id               String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  trip_id          String?
  driver_id        String
  passenger_id     String
  match_type       String         @db.VarChar(20)
  driver_base_lat  Decimal?       @db.Decimal(10, 8)
  driver_base_lng  Decimal?       @db.Decimal(11, 8)
  pickup_lat       Decimal?       @db.Decimal(10, 8)
  pickup_lng       Decimal?       @db.Decimal(11, 8)
  neighborhood_id  String?
  platform_percent Decimal?       @db.Decimal(5, 2)
  platform_fee_brl Decimal?       @db.Decimal(10, 2)
  trip_value_brl   Decimal?       @db.Decimal(10, 2)
  created_at       DateTime?      @default(now()) @db.Timestamp(6)
  drivers          drivers        @relation(fields: [driver_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  neighborhoods    neighborhoods? @relation(fields: [neighborhood_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  passengers       passengers     @relation(fields: [passenger_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at], map: "idx_match_logs_created")
  @@index([driver_id], map: "idx_match_logs_driver")
  @@index([trip_id], map: "idx_match_logs_trip")
  @@index([match_type], map: "idx_match_logs_type")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum TourBookingStatus {
  REQUESTED
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum TourPackageType {
  TOUR
  AIRPORT_TRANSFER
}
